<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Native JS Modals</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link rel="stylesheet" href="page.css" type="text/css" media="screen, handheld, projection">

    <script>
        "use strict";

        var nModal = (function () {
            var nInit = function (_options) {
                var defaultOptions = {
                    watch: true,
                    backdrop: true
                };

                var options = Object.assign({}, defaultOptions, _options);

                var $modalTriggers = document.querySelectorAll("[data-nModal]");
                var $modalContainer = document.querySelector("#nModal-container");
                var $modalPlaceholder = void 0;

                var modalTriggerClickEventHandler = function modalTriggerClickEventHandler(e, $modalTrigger) {
                    e.preventDefault();
                    var modalTarget = $modalTrigger.dataset.nmodal;
                    var modalSize = $modalTrigger.dataset.nmodalSize ? $modalTrigger.dataset.nmodalSize : "small";
                    var $modalTargetDom = document.getElementById(modalTarget);
                    var $nodeToCopy = void 0;

                    if (typeof modalTarget === 'undefined') {
                        return;
                    }

                    // See if we can find a node to copy,
                    // i.e. does the targeted node contain anything
                    $modalTargetDom.childNodes.forEach(function (node) {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            $nodeToCopy = node;
                        }
                    });

                    // Copy the targeted node to the nModal placeholder
                    if ($nodeToCopy) {
                        var $modalCopy = $nodeToCopy.cloneNode(true);
                        $modalPlaceholder.classList.remove("large", "small", "max");

                        switch (modalSize) {
                            case "small":
                                $modalPlaceholder.classList.add("small");
                                break;
                            case "large":
                                $modalPlaceholder.classList.add("large");
                                break;
                            case "max":
                                $modalPlaceholder.classList.add("max");
                                break;
                        }

                        $modalContainer.classList.add("active");
                        while ($modalPlaceholder.firstChild) {
                            $modalPlaceholder.removeChild($modalPlaceholder.firstChild);
                        }
                        var $newElement = $modalPlaceholder.insertAdjacentElement("afterbegin", $modalCopy);

                        // Register callbacks in the modal
                        $modalPlaceholder.querySelectorAll(".nModal-button").forEach(function ($element) {
                            $element.addEventListener("click", function (e) {
                                e.preventDefault();

                                if ($element.dataset.nmodalCallback) {
                                    window[$element.dataset.nmodalCallback]($newElement);
                                }
                            });
                        });
                    }
                    else {
                        console.info(modalTarget, 'doesn\'t have content to display. Add at least a &lt;form&gt;.');
                    }
                };

                if (!$modalContainer) {
                    // Add the nModal container
                    var $_container = document.createElement("div");
                    $_container.setAttribute("id", "nModal-container");
                    if (options.backdrop) {
                        $_container.classList.add('backdrop');
                    }

                    document.body.insertAdjacentElement("afterbegin", $_container);

                    // Add the nModal
                    var $_modalPlaceholder = document.createElement("div");
                    $_modalPlaceholder.setAttribute("id", "nModal-placeholder");

                    $_container.insertAdjacentElement("afterbegin", $_modalPlaceholder);

                    // Assign variables
                    $modalContainer = $_container;
                    $modalPlaceholder = $_modalPlaceholder;
                }

                // nModal close event
                $modalContainer.addEventListener("click", function (e) {
                    if (e.target.id === "nModal-container" || e.target.classList.contains("nModal-button__cancel")) {
                        $modalContainer.classList.remove("active");
                    }
                });

                // Assign the nModal triggers
                $modalTriggers.forEach(function ($modalTrigger) {
                    $modalTrigger.addEventListener("click", function (e) {
                        modalTriggerClickEventHandler(e, $modalTrigger);
                    });
                });

                // Watch the DOM for changes and assign triggers
                if (options.watch) {
                    if (typeof MutationObserver !== 'undefined') {
                        var observer = new MutationObserver(function (mutations) {
                            mutations.forEach(function (mutation) {
                                for (var i = 0; i < mutation.addedNodes.length; i++) {
                                    let $modalTrigger = mutation.addedNodes[i];
                                    if ($modalTrigger.dataset.hasOwnProperty('nmodal')) {
                                        $modalTrigger.addEventListener("click", function (e) {
                                            modalTriggerClickEventHandler(e, $modalTrigger);
                                        });
                                    }
                                }
                            });
                        });
                        observer.observe(document, {
                            childList: true
                        });
                    }
                }

                document.addEventListener("keydown", function (event) {
                    var key = event.key;
                    if (key === "Escape" && $modalContainer.classList.contains("active")) {
                        event.preventDefault();
                        nModal.close();
                    }
                });
            };

            // Close the nModal
            var nClose = function () {
                var $modalContainer = document.querySelector("#nModal-container");
                $modalContainer.classList.remove("active");
            };

            // Expose nModal variable
            return {
                init: nInit,
                close: nClose
            };
        })();
    </script>
    <style>
        body {
            font-family: 'Roboto', sans-serif; }
    </style>

</head>
<body>
<div>
    <a href="" data-nmodal="testModal">Click here</a> to open a small modal.<br>
    <a href="" data-nmodal="testModal2" data-nmodal-size="large">Click here</a> to open a large modal.<br>
    <a href="" data-nmodal="testModal2" data-nmodal-size="max">Click here</a> to open a maximised modal.
</div>

<div id="testModal" class="nModal">
    <form action="">
        <div class="nModal-header">Modal 1</div>
        <div class="nModal-body">Body of the modal</div>
        <div class="nModal-buttons">
            <a href="" class="nModal-button nModal-button__ok" data-nmodal-callback="callback">Ok</a>
            <a href="" class="nModal-button nModal-button__cancel">Cancel</a>
        </div>
    </form>
</div>
<div id="testModal2" class="nModal">
    <form action="">
        <div class="nModal-header">Modal 2</div>
        <div class="nModal-body">
            Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aperiam architecto deserunt enim error, natus nihil odit reprehenderit tempore? Accusamus assumenda commodi consequuntur corporis dolor expedita explicabo iusto necessitatibus nobis similique. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid, architecto commodi eius eos ex fugit in laboriosam molestias odit perspiciatis quas quidem reiciendis saepe sed sit tempore vel, veniam vero?
        </div>
        <div class="nModal-buttons">
            <a href="" class="nModal-button nModal-button__ok" data-nmodal-callback="callback">Ok</a>
            <a href="" class="nModal-button nModal-button__cancel">Cancel</a>
        </div>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        nModal.init({
            watch: true,
            backdrop: true
        });

        window.callback = function (arg) {
            console.info('Callback', arg);
            nModal.close();
        };
    });
</script>
</body>
</html>